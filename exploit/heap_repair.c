#include "funcs.h"

static
struct __attribute__((packed)) {
    uint32_t free_bytes;

    uint32_t chunk_cnt;
    struct {
        void *base;
        void *end;
    } chunks[4];

    void *free_list[32];
} *heap_meta = (void *)HEAP_METADATA;

const
uint32_t chunks[] = HEAP_CHUNKS;

static const
size_t chunks_cnt = sizeof(chunks) / sizeof(*chunks);

static
void process_chunk(void *base) {
    uint32_t total_size = 0;
    uint32_t free_size = 0;

    void *curr = base;

    int idx = 0;
    while (1) {
        uint32_t prev = *(uint32_t *)curr;
        uint32_t cur  = *((uint32_t *)curr + 1);
        bool this_free = (prev & 1) != 0;
        bool prev_free = (prev & 2) != 0;

        uint32_t size = cur << HEAP_BLOCKSIZE_SHIFT;

        total_size += size;

        if (this_free) {
            free_size += size;

            void *bkd = *(void **)(curr + (1 << HEAP_BLOCKSIZE_SHIFT) + 4);

            if (bkd >= (void *)&heap_meta->free_list && bkd < (void *)(heap_meta + 1)) {
                *(void **)bkd = curr;
            }
        }

        if (cur == 1 && idx != 0) {
            break;
        }

        curr += size;
        idx++;
    }

    printf("chunk @ %p, total_size: 0x%x\n", base, total_size);

    heap_meta->chunks[heap_meta->chunk_cnt].base = base;
    heap_meta->chunks[heap_meta->chunk_cnt].end = base + total_size;
    heap_meta->chunk_cnt++;

    heap_meta->free_bytes += free_size;
}

void heap_repair() {
    printf("repairing heap metadata\n");

    /* clear out corrupted heap metadata */
    memset(heap_meta, 0, sizeof(*heap_meta));

    /* iterating chunks and fixing the metadata accordingly */
    for (int i = 0; i < chunks_cnt; i++) {
        process_chunk((void *)chunks[i]);
    }
}

#if 0

static
void dump_heap() {
    int idx = 0;
    void *base = (void *)0x4C000000;

    while (1) {
        uint32_t prev = *(uint32_t *)base;
        uint32_t cur  = *((uint32_t *)base + 1);
        bool this_free = (prev & 1) != 0;
        bool prev_free = (prev & 2) != 0;

        uint32_t size = cur << HEAP_BLOCKSIZE_SHIFT;

        printf("block[%d] @ %p-%p this_free: %d prev_free: %d\n", idx, base, base+size, this_free, prev_free);

        if (cur == 1 && idx != 0) {
            break;
        }

        base += size;
        idx++;
    }
}

#endif
