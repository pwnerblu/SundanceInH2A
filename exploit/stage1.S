.text

.arm
.globl start
start:
    b cont

.org 0x84

cont:
    // invalidate caches
    mov  r5, #:lower16:ARM_CLEAN_CACHES
    movt r5, #:upper16:ARM_CLEAN_CACHES
    blx  r5

    // print signature text
    adr r0, hello_str
    ldr r4, =PRINTF
    blx r4

    // grab nand0c bdev (hopefully...)
    ldr r0, =BDEV_LIST
    ldr r0, [r0]

    // read stage2 from offset 0x4000 of nand0c
    mov r2, #0x4000         // desired offset & length
    ldr r4, [r0, #0x10]     // blockdev block size shift
    lsr r2, r2, r4          // block index
    mov r3, r2              // block count
    ldr r1, =STAGE2_BASE    // destination addr
    ldr r4, [r0, #0x20]     // read hook addr
    blx r4

    // invalidate caches again
    blx r5

    // jump to stage2
    ldr r0, =STAGE2_BASE
    add r0, #0x1
    bx  r0

hello_str:
    .asciz "Hello darkness, my old friend\n"
